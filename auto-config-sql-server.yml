---
- name: Setup MySQL Server with Advanced Configuration and Security
  hosts: all
  become: yes

  vars:
  apache_users:
    - { name: "adminsql", group: "sqladmin", sudo: true }
    - { name: "devsql", group: "sqldev", sudo: false }
    - { name: "auditor", group: "auditores", sudo: false }

  tasks:
    - name: Instalar MySQL Server
      apt:
        name: mysql-server
        state: present
        update_cache: yes

    - name: Habilitar y arrancar MySQL
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Configurar contraseña compleja y plugin para root (login con contraseña)
      mysql_user:
        name: root
        host: localhost
        password: "ElAdmin1853"
        plugin: mysql_native_password
        login_unix_socket: /var/run/mysqld/mysqld.sock
        state: present

    - name: Crear grupos para jerarquía empresarial
      group:
        name: "{{ item }}"
        state: present
      loop:
        - sqladmins
        - sqldevs
        - auditores

    - name: Crear usuarios con jerarquía empresarial
      user:
        name: "{{ item.name }}"
        group: "{{ item.group }}"
        shell: /bin/bash
        create_home: yes
        state: present
      loop: "{{ apache_users }}"

    - name: Establecer claves SSH para los usuarios
      authorized_key:
        user: "{{ item.name }}"
        key: "ssh-rsa CuentasSQL1853"
        state: present
      loop: "{{ apache_users }}"

    - name: Asignar privilegios sudo limitados solo a adminweb
      lineinfile:
        dest: /etc/sudoers.d/{{ item.name }}
        line: "{{ item.name }} ALL=(ALL) NOPASSWD: /bin/systemctl restart apache2"
        create: yes
        mode: '0440'
      when: item.sudo
      loop: "{{ apache_users }}"

    - name: Instalar fail2ban
      apt:
        name: fail2ban
        state: present

    - name: Crear grupo de administración ACL para usuarios de MySQL
      group:
        name: mysqladmins
        state: present

    - name: Configurar archivo seguro para exportaciones en MySQL
      mysql_variables:
        name: secure-file-priv
        value: "/var/lib/mysql-files"
        state: present

    - name: Configurar UFW - permitir SSH
      ufw:
        rule: allow
        name: "OpenSSH"
        port: 22

    - name: Habilitar y permitir acceso al puerto 3306 (MySQL)
      ufw:
        state: enabled
        rule: allow
        port: 3306
        proto: tcp

    - name: Realizar backup completo de MySQL
      shell: mysqldump --all-databases > /var/backups/all_databases_$(date +'%Y-%m-%d').sql
      register: backup_result

    - name: Mostrar resultado del backup
      debug:
        msg: "Backup realizado correctamente."

    - name: Configurar auditoría básica en MySQL
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: '^#?audit_log'
        line: 'audit_log=FORCE_PLUS_PERMANENT'
      notify:
        - Restart MySQL

  handlers:
    - name: Restart MySQL
      service:
        name: mysql
        state: restarted